<!--
  This is a Freshplug that list all available categories and folders. When clicking on a create tutorial button, the Iorad page shows up. Upon closing the tutorial page, it is automatically added to a new article page in a selected folder.
-->
{% if portal.user.is_agent %}
<section id="ioradWidget" class="help-center rounded-6 iorad-widget hide-in-mobile" title="Iorad Tutorial Widget">
  <div id="tutorialLocation" class="widget-layout">
    <div class="widget-header"><h2 class="heading">Create a Solution</h2></div>
    <div class="widget-location-selector"><div class="selector-label"><h4>Categories</h4></div><div><select id="categorySelector"></select></div></div>
    <div class="widget-location-selector"><div class="selector-label"><h4>Solutions</h4></div><div id='foldersList'></div></div>
    <div id="control">
      <a id='newTutorialBtn' class='btn btn-iorad-widget' title='open IORAD editor' href='#'>ADD</a>
    </div>
  </div>
</section>
{% endif %}
<style>
.invisible-options{
  display: none;
}
.iorad-widget div {
  display: inline-block;
}
#control {
  float: right;
  position: relative;
}
.widget-layout {
  width: 98%;
}
.widget-header {
  padding-right: 2em;
}
.widget-location-selector {
  padding-right: 2em;
  height: 30px;
}
.widget-location-selector .selector-label {
  padding-right: 1em;
  vertical-align: middle;
}
.btn-iorad-widget {
  color: white;
  background-color: #006063;
  background-image: none;
  text-shadow: 0 -1px 0 rgba(0,0,0,0.25);
  width: 112px;
  line-height: 26px;
}
.iorad-widget-modal {
  width: 28%;
  font-size: 16px;
}
</style>
<script type='text/javascript' src='//iorad.com/server/assets/js/iorad.js'></script>
<script type="text/javascript">
  (function ($, win){
    var initializeWidget = function () {
      iorad = win.iorad || {};
    
      var SOLUTION_CATEGORIES_API_URL = '/solution/categories.json';
      var ARTICLE_API_URL = '/solution/categories/{category_id}/folders/{folder_id}/articles.json';
      var freshdeskAjaxOption = function () {
        return {
          dataType: 'json',
          contentType: 'application/json'
        };
      };

      var listCategories = function () {
        var ajaxOptions = freshdeskAjaxOption();
        ajaxOptions.type = 'GET';
        ajaxOptions.url = SOLUTION_CATEGORIES_API_URL;
        return $.ajax( ajaxOptions );
      };

      var createArticle = function (categoryId, folderId, article) {
        var ajaxOptions = freshdeskAjaxOption();
        ajaxOptions.type = 'POST';
        ajaxOptions.url = ARTICLE_API_URL.replace( '{category_id}', categoryId.toString() ).replace( '{folder_id}', folderId.toString() );
        ajaxOptions.data = article;
        return $.ajax(ajaxOptions);
      };

      var categoryChangedHandler = function (e) {
        var $categorySelector = $(e.srcElement);
        $("#foldersList").children().each( function (index, childSelector) {
          $(childSelector).addClass("invisible-options");
        });
        $("#" + $categorySelector.val()).removeClass("invisible-options");
      };

      var populateTutorialLocation = function (data) {
        var options = '';
        var foldersSelectors = '';
        data.each( function (categoryObj) {
          options += '<option value="' + categoryObj.category.id + '">' + categoryObj.category.name + '</option>';
          var selector = '<select id="'+ categoryObj.category.id +'"class="invisible-options">';
          categoryObj.category.folders.each( function (folderObj) {
            selector += '<option value="' + folderObj.id + '">' + folderObj.name + '</option>';
          });
          selector += '</select>';
          foldersSelectors += selector;
        });

        var $categorySelector = $("#categorySelector");
        $categorySelector.html(options);
        $("#foldersList").html(foldersSelectors);
        $("#" + $categorySelector.val()).removeClass("invisible-options");
        $categorySelector.click(categoryChangedHandler);
      };

      listCategories().then(populateTutorialLocation, function (err) {});

      iorad.init({env:'live'}, function () {
        // iorad is ready now.
        var t = 0;

        // register events
        $("#newTutorialBtn").click( function() {
          $("body").addClass("iorad-loading");
          iorad.createTutorial();
          t = setTimeout( function () {
            $("body").removeClass("iorad-loading");
          }, 5000);
          $("#iorad-editor").off().load( function () {
            $("body").addClass("iorad-open");
            clearTimeout(t);
          });
        });

        iorad.on('editor:close', function(tutorialParams) {
          $('body').removeClass('iorad-open iorad-loading');
          clearTimeout(t);
          var iframeHTML = iorad.getEmbeddedPlayerUrl(tutorialParams.uid,
                            tutorialParams.tutorialId, tutorialParams.tutorialTitle);       

          var $tutorialViewStepsIframe = $(iframeHTML);

          $tutorialViewStepsIframe.attr("src", $tutorialViewStepsIframe.attr("src") + "#viewsteps");

          var categoryId = $("#categorySelector").val();
          var folderId = $( "#" + categoryId ).val();
          var MODAL_TEMPLATE = "<div class=\"modal hide fade iorad-widget-modal\" role=\"dialog\" id=\"successModal\" aria-hidden=\"true\" style=\"display:none;\"><div class=\"modal-header\"></div><div class=\"modal-body\"><div id=\"successMsg\"></div></div><div class=\"modal-footer\"><button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Close</button><a class=\"btn btn-primary\" href=\"{url}\">VIEW ARTICLE</a></div></div>";
          var SUCCESS_MSG_TEMPLATE = "The solution <b>{msg}</b> has been successfully created.";
          var ARTICLE_URL = "/solution/categories/{categoryId}/folders/{folderId}/articles/{id}";
          var article = {
            solution_article: {
              "title": tutorialParams.tutorialTitle,
              "folder_id": folderId,
              "description": "<div>" + $tutorialViewStepsIframe.prop("outerHTML").replace(/\"/g, "'") + "</div>"
            }
          };

          var articleJson = JSON.stringify(article);
            
          createArticle( categoryId, folderId, articleJson ).then( function ( data )
          {                        
            var articleUrl = ARTICLE_URL.replace('{categoryId}', categoryId)
                                        .replace('{folderId}', folderId)
                                        .replace( '{id}', data.article.id );

            // add a safe guard here.
            if ( $( "#successModal" ).length > 0 ) {
              $( "#successModal" ).remove();
            }

            $( 'body' ).append( MODAL_TEMPLATE.replace('{url}', articleUrl));

            var $successMsg = $( "#successMsg" );
            $successMsg.html( SUCCESS_MSG_TEMPLATE.replace( '{msg}', tutorialParams.tutorialTitle ) );
            $( "#successModal" ).modal( 'show' );
          }, function (err){});
        });

      } );
  
    };

    var ioradLoaded = function (callback) {
      var interval = 10;
      var tryLoad = function () {
        if(win.iorad){
          callback();
        } else {
          win.setTimeout(tryLoad, interval);
        }
      };

      win.setTimeout(tryLoad, interval);
    };

    ioradLoaded(initializeWidget);
  })(jQuery, window);

</script>